PROGRAM Util_WriteMetaDataCVTfile

! ===========================================================
! Program to write longs_v and half_levs to existing cov file
! Ross Bannister, April 2020
!
! To compile (Ubuntu)
!   f95 Util_WriteMetaDataCVTfile.f90 -o Util_WriteMetaDataCVTfile.out -L/usr/local/lib -lnetcdff
! (UoR)
!   f95 Util_WriteMetaDataCVTfile.f90 -o Util_WriteMetaDataCVTfile.out -L/home/users/sws98rnb/Lib/lib -lnetcdff
!   
! ===========================================================


IMPLICIT NONE

! NetCDF library (file format used to read/write data)
!----------------------------------------------------
INCLUDE '/scratch/singadm/pkg_hera/netcdf/4.3.3/gnu/4.9.2/include/netcdf.inc'

INTEGER, PARAMETER        :: ZREAL8 = SELECTED_REAL_KIND(15,307)
INTEGER, PARAMETER        :: nlongs = 360            ! total number of longitude points
INTEGER, PARAMETER        :: nlevs  = 60             ! total number of vertical levels

REAL(ZREAL8) :: longs_v(1:nlongs)
REAL(ZREAL8) :: half_levs(1:nlevs)
INTEGER      :: ierr, ncid, varid_longs, varid_level
INTEGER      :: start(1), count(1)


! Initialise the arrays

longs_v = (/ 1500., 3000., 4500., 6000., 7500., 9000., 10500., 12000., 13500., 15000.,  &
    16500., 18000., 19500., 21000., 22500., 24000., 25500., 27000., 28500., 30000.,     &
    31500., 33000., 34500., 36000., 37500., 39000., 40500., 42000., 43500., 45000.,     &
    46500., 48000., 49500., 51000., 52500., 54000., 55500., 57000., 58500., 60000.,     &
    61500., 63000., 64500., 66000., 67500., 69000., 70500., 72000., 73500., 75000.,     &
    76500., 78000., 79500., 81000., 82500., 84000., 85500., 87000., 88500., 90000.,     &
    91500., 93000., 94500., 96000., 97500., 99000., 100500., 102000., 103500., 105000., &
    106500., 108000., 109500., 111000., 112500., 114000., 115500., 117000., 118500.,    &
    120000., 121500., 123000., 124500., 126000., 127500., 129000., 130500., 132000.,    &
    133500., 135000., 136500., 138000., 139500., 141000., 142500., 144000., 145500.,    &
    147000., 148500., 150000., 151500., 153000., 154500., 156000., 157500., 159000.,    &
    160500., 162000., 163500., 165000., 166500., 168000., 169500., 171000., 172500.,    &
    174000., 175500., 177000., 178500., 180000., 181500., 183000., 184500., 186000.,    &
    187500., 189000., 190500., 192000., 193500., 195000., 196500., 198000., 199500.,    &
    201000., 202500., 204000., 205500., 207000., 208500., 210000., 211500., 213000.,    &
    214500., 216000., 217500., 219000., 220500., 222000., 223500., 225000., 226500.,    &
    228000., 229500., 231000., 232500., 234000., 235500., 237000., 238500., 240000.,    &
    241500., 243000., 244500., 246000., 247500., 249000., 250500., 252000., 253500.,    &
    255000., 256500., 258000., 259500., 261000., 262500., 264000., 265500., 267000.,    &
    268500., 270000., 271500., 273000., 274500., 276000., 277500., 279000., 280500.,    &
    282000., 283500., 285000., 286500., 288000., 289500., 291000., 292500., 294000.,    &
    295500., 297000., 298500., 300000., 301500., 303000., 304500., 306000., 307500.,    &
    309000., 310500., 312000., 313500., 315000., 316500., 318000., 319500., 321000.,    &
    322500., 324000., 325500., 327000., 328500., 330000., 331500., 333000., 334500.,    &
    336000., 337500., 339000., 340500., 342000., 343500., 345000., 346500., 348000.,    &
    349500., 351000., 352500., 354000., 355500., 357000., 358500., 360000., 361500.,    &
    363000., 364500., 366000., 367500., 369000., 370500., 372000., 373500., 375000.,    &
    376500., 378000., 379500., 381000., 382500., 384000., 385500., 387000., 388500.,    &
    390000., 391500., 393000., 394500., 396000., 397500., 399000., 400500., 402000.,    &
    403500., 405000., 406500., 408000., 409500., 411000., 412500., 414000., 415500.,    &
    417000., 418500., 420000., 421500., 423000., 424500., 426000., 427500., 429000.,    &
    430500., 432000., 433500., 435000., 436500., 438000., 439500., 441000., 442500.,    &
    444000., 445500., 447000., 448500., 450000., 451500., 453000., 454500., 456000.,    &
    457500., 459000., 460500., 462000., 463500., 465000., 466500., 468000., 469500.,    &
    471000., 472500., 474000., 475500., 477000., 478500., 480000., 481500., 483000.,    &
    484500., 486000., 487500., 489000., 490500., 492000., 493500., 495000., 496500.,    &
    498000., 499500., 501000., 502500., 504000., 505500., 507000., 508500., 510000.,    &
    511500., 513000., 514500., 516000., 517500., 519000., 520500., 522000., 523500.,    &
    525000., 526500., 528000., 529500., 531000., 532500., 534000., 535500., 537000.,    &
    538500., 540000. /)

half_levs = (/ 128.355867513021, 385.067602539062, 641.779337565104,                    &
    898.491072591146, 1155.20280761719, 1411.91454264323, 1668.62627766927,             &
    1925.33801269531, 2182.04974772135, 2438.7614827474, 2695.47321777344,              &
    2952.18495279948, 3208.89668782552, 3465.60842285156, 3722.3201578776,              &
    3979.03189290365, 4235.74362792969, 4492.45536295573, 4749.16709798177,             &
    5005.87883300781, 5262.59056803385, 5519.3023030599, 5776.01403808594,              &
    6032.72577311198, 6289.43750813802, 6546.14924316406, 6802.8609781901,              &
    7059.57271321615, 7316.28444824219, 7572.99618326823, 7829.70791829427,             &
    8086.41965332031, 8343.13138834635, 8599.84312337239, 8856.55485839844,             &
    9113.26659342448, 9369.97832845052, 9626.69006347656, 9883.4017985026,              &
    10140.1135335286, 10396.8252685547, 10653.5370035807, 10910.2487386068,             &
    11166.9604736328, 11423.6722086589, 11680.3839436849, 11937.0956787109,             &
    12193.807413737, 12450.519148763, 12707.2308837891, 12963.9426188151,               &
    13220.6543538411, 13477.3660888672, 13734.0778238932, 13990.7895589193,             &
    14247.5012939453, 14504.2130289714, 14760.9247639974, 15017.6364990234,             &
    15274.3482340495 /)

! Open the file to be modified

ierr     = NF_OPEN ('/home/ross/DataAssim/RuthsModel/ABC_vn1.4da/RACC_work/NewCalibration1/CVTfiles/GB+HB+AB+/CVT.nc',&
                    NF_WRITE, ncid)
IF (ierr /= 0) THEN
  PRINT*, 'Error opening netcdf file'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF


ierr     = NF_INQ_VARID(ncid, 'longs', varid_longs)
IF (ierr /= 0) THEN
  PRINT*, 'Error getting varid for longs'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF

ierr     = NF_INQ_VARID(ncid, 'level', varid_level)
IF (ierr /= 0) THEN
  PRINT*, 'Error getting varid for level'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF


start(1) = 1
count(1) = nlongs
ierr     = NF_PUT_VARA_DOUBLE(ncid, varid_longs, start, count, longs_v(1:nlongs))
IF (ierr /= 0) THEN
  PRINT*, 'Error writing longitudes'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF

start(1) = 1
count(1) = nlevs
ierr     = NF_PUT_VARA_DOUBLE(ncid, varid_level, start, count, half_levs(1:nlevs))
IF (ierr /= 0) THEN
  PRINT*, 'Error writing levels'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF


ierr     = NF_CLOSE(ncid)
IF (ierr /= 0) THEN
  PRINT*, 'Error closing file'
  PRINT*, 'ierr ',  ierr,  NF_STRERROR(ierr)
  STOP
END IF



END PROGRAM Util_WriteMetaDataCVTfile
